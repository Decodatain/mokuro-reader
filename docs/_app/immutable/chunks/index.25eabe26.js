import{d as W}from"./db.60763777.js";import{a as v}from"./snackbar.55a9a3ca.js";import{d as Se,g as Le,U as Q,E as Y,a as Ce,b as be,S as Me,M,e as S,Z as H,f as xe,h as X,i as Ee,C as de,F as ue,D as Ue,j as ke,k as ze,l as Be,L as ve,m as Ye,n as Ze,B as je,o as _e,q as ge,r as Ge,s as Ve,t as We,u as He,v as Xe,w as Ke,x as qe,y as Re,z as $e,A as he}from"./index.a8881894.js";import{i as Je,a as $,B as Qe,r as h,E as me,b as et,c as tt,P as at,d as nt,e as st,f as it,g as rt,h as ot,j as ct,k as ft,l as lt,m as Et,n as dt,o as ut,p as _t,q as gt,U as Rt,s as mt}from"./zip-entry.9dbb5bd8.js";async function Dt(){navigator.storage&&navigator.storage.persist&&await navigator.storage.persist()}function Ht(a,e=2){if(a===0)return"0 B";const n=1024,t=e<0?0:e,o=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],s=Math.floor(Math.log(a)/Math.log(n));return`${parseFloat((a/n**s).toFixed(t))} ${o[s]}`}function J(a,e){return e&&e.trim().toLowerCase()=="cp437"?Se(a):new TextDecoder(e).decode(a)}const K="File format is not recognized",wt="End of central directory not found",pt="End of Zip64 central directory not found",Tt="End of Zip64 central directory locator not found",Ot="Central directory header not found",At="Local file header not found",ht="Zip64 extra field not found",Ft="File contains encrypted entry",Pt="Encryption method not supported",De="Compression method not supported",we="Split zip file",pe="utf-8",Te="cp437",Nt=[[at,M],[nt,M],[st,M],[it,S]],It={[S]:{getValue:_,bytes:4},[M]:{getValue:Z,bytes:8}};class yt{constructor(e,n={}){Object.assign(this,{reader:Je(e),options:n,config:Le()})}async*getEntriesGenerator(e={}){const n=this;let{reader:t}=n;const{config:o}=n;if(await $(t),(t.size===Q||!t.readUint8Array)&&(t=new Qe(await new Response(t.readable).blob()),await $(t)),t.size<Y)throw new Error(K);t.chunkSize=Ce(o);const s=await xt(t,be,t.size,Y,S*16);if(!s){const O=await h(t,0,4),u=m(O);throw _(u)==Me?new Error(we):new Error(wt)}const c=m(s);let r=_(c,12),i=_(c,16);const E=s.offset,l=R(c,20),d=E+Y+l;let f=R(c,4);const A=t.lastDiskNumber||0;let p=R(c,6),N=R(c,8),g=0,x=0;if(i==M||r==M||N==S||p==S){const O=await h(t,s.offset-H,H),u=m(O);if(_(u,0)!=xe)throw new Error(pt);i=Z(u,8);let I=await h(t,i,X,-1),F=m(I);const y=s.offset-H-X;if(_(F,0)!=Ee&&i!=y){const C=i;i=y,g=i-C,I=await h(t,i,X,-1),F=m(I)}if(_(F,0)!=Ee)throw new Error(Tt);f==S&&(f=_(F,16)),p==S&&(p=_(F,20)),N==S&&(N=Z(F,32)),r==M&&(r=Z(F,40)),i-=r}if(A!=f)throw new Error(we);if(i<0||i>=t.size)throw new Error(K);let D=0,T=await h(t,i,r,p),w=m(T);if(r){const O=s.offset-r;if(_(w,D)!=de&&i!=O){const u=i;i=O,g=i-u,T=await h(t,i,r,p),w=m(T)}}const L=s.offset-i-(t.lastDiskOffset||0);if(r!=L&&L>=0&&(r=L,T=await h(t,i,r,p),w=m(T)),i<0||i>=t.size)throw new Error(K);const j=P(n,e,"filenameEncoding"),z=P(n,e,"commentEncoding");for(let O=0;O<N;O++){const u=new St(t,o,n.options);if(_(w,D)!=de)throw new Error(Ot);Fe(u,w,D+6);const I=!!u.bitFlag.languageEncodingFlag,F=D+46,y=F+u.filenameLength,C=y+u.extraFieldLength,k=R(w,D+4),b=(k&0)==0,ee=T.subarray(F,y),te=R(w,D+32),ae=C+te,ne=T.subarray(C,ae),se=I,ie=I,re=b&&(U(w,D+38)&ue)==ue,oe=_(w,D+42)+g;Object.assign(u,{versionMadeBy:k,msDosCompatible:b,compressedSize:0,uncompressedSize:0,commentLength:te,directory:re,offset:oe,diskNumberStart:R(w,D+34),internalFileAttribute:R(w,D+36),externalFileAttribute:_(w,D+38),rawFilename:ee,filenameUTF8:se,commentUTF8:ie,rawExtraField:T.subarray(y,C)});const[ce,Ie]=await Promise.all([J(ee,se?pe:j||Te),J(ne,ie?pe:z||Te)]);Object.assign(u,{rawComment:ne,filename:ce,comment:Ie,directory:re||ce.endsWith(Ue)}),x=Math.max(oe,x),await Pe(u,u,w,D+6);const V=new me(u);V.getData=(le,ye)=>u.getData(le,V,ye),D=ae;const{onprogress:fe}=e;if(fe)try{await fe(O+1,N,new me(u))}catch{}yield V}const B=P(n,e,"extractPrependedData"),G=P(n,e,"extractAppendedData");return B&&(n.prependedData=x>0?await h(t,0,x):new Uint8Array),n.comment=l?await h(t,E+Y,l):new Uint8Array,G&&(n.appendedData=d<t.size?await h(t,d,t.size-d):new Uint8Array),!0}async getEntries(e={}){const n=[];for await(const t of this.getEntriesGenerator(e))n.push(t);return n}async close(){}}class St{constructor(e,n,t){Object.assign(this,{reader:e,config:n,options:t})}async getData(e,n,t={}){const o=this,{reader:s,offset:c,diskNumberStart:r,extraFieldAES:i,compressionMethod:E,config:l,bitFlag:d,signature:f,rawLastModDate:A,uncompressedSize:p,compressedSize:N}=o,g=o.localDirectory={},x=await h(s,c,30,r),D=m(x);let T=P(o,t,"password");if(T=T&&T.length&&T,i&&i.originalCompressionMethod!=ke)throw new Error(De);if(E!=ze&&E!=Be)throw new Error(De);if(_(D,0)!=ve)throw new Error(At);Fe(g,D,4),g.rawExtraField=g.extraFieldLength?await h(s,c+30+g.filenameLength,g.extraFieldLength,r):new Uint8Array,await Pe(o,g,D,4),Object.assign(n,{lastAccessDate:g.lastAccessDate,creationDate:g.creationDate});const w=o.encrypted&&g.encrypted,L=w&&!i;if(w){if(!L&&i.strength===Q)throw new Error(Pt);if(!T)throw new Error(Ft)}const j=c+30+g.filenameLength+g.extraFieldLength,z=N,B=s.readable;Object.assign(B,{diskNumberStart:r,offset:j,size:z});const G=P(o,t,"signal"),O=P(o,t,"checkPasswordOnly");O&&(e=new WritableStream),e=et(e),await $(e,p);const{writable:u}=e,{onstart:I,onprogress:F,onend:y}=t,C={options:{codecType:Ye,password:T,zipCrypto:L,encryptionStrength:i&&i.strength,signed:P(o,t,"checkSignature"),passwordVerification:L&&(d.dataDescriptor?A>>>8&255:f>>>24&255),signature:f,compressed:E!=0,encrypted:w,useWebWorkers:P(o,t,"useWebWorkers"),useCompressionStream:P(o,t,"useCompressionStream"),transferStreams:P(o,t,"transferStreams"),checkPasswordOnly:O},config:l,streamOptions:{signal:G,size:z,onstart:I,onprogress:F,onend:y}};let k=0;try{({outputSize:k}=await tt({readable:B,writable:u},C))}catch(b){if(!O||b.message!=Ze)throw b}finally{const b=P(o,t,"preventClose");u.size+=k,!b&&!u.locked&&await u.getWriter().close()}return O?void 0:e.getData?e.getData():u}}function Fe(a,e,n){const t=a.rawBitFlag=R(e,n+2),o=(t&Re)==Re,s=_(e,n+6);Object.assign(a,{encrypted:o,version:R(e,n),bitFlag:{level:(t&je)>>1,dataDescriptor:(t&_e)==_e,languageEncodingFlag:(t&ge)==ge},rawLastModDate:s,lastModDate:Ut(s),filenameLength:R(e,n+22),extraFieldLength:R(e,n+24)})}async function Pe(a,e,n,t){const{rawExtraField:o}=e,s=e.extraField=new Map,c=m(new Uint8Array(o));let r=0;try{for(;r<o.length;){const N=R(c,r),g=R(c,r+2);s.set(N,{type:N,data:o.slice(r+4,r+4+g)}),r+=4+g}}catch{}const i=R(n,t+4);Object.assign(e,{signature:_(n,t+10),uncompressedSize:_(n,t+18),compressedSize:_(n,t+14)});const E=s.get(Ge);E&&(Lt(E,e),e.extraFieldZip64=E);const l=s.get(Ve);l&&(await Oe(l,ot,rt,e,a),e.extraFieldUnicodePath=l);const d=s.get(We);d&&(await Oe(d,ft,ct,e,a),e.extraFieldUnicodeComment=d);const f=s.get(He);f?(Ct(f,e,i),e.extraFieldAES=f):e.compressionMethod=i;const A=s.get(Xe);A&&(bt(A,e),e.extraFieldNTFS=A);const p=s.get(Ke);p&&(Mt(p,e),e.extraFieldExtendedTimestamp=p)}function Lt(a,e){e.zip64=!0;const n=m(a.data),t=Nt.filter(([o,s])=>e[o]==s);for(let o=0,s=0;o<t.length;o++){const[c,r]=t[o];if(e[c]==r){const i=It[r];e[c]=a[c]=i.getValue(n,s),s+=i.bytes}else if(a[c])throw new Error(ht)}}async function Oe(a,e,n,t,o){const s=m(a.data),c=new $e;c.append(o[n]);const r=m(new Uint8Array(4));r.setUint32(0,c.get(),!0);const i=_(s,1);Object.assign(a,{version:U(s,0),[e]:J(a.data.subarray(5)),valid:!o.bitFlag.languageEncodingFlag&&i==_(r,0)}),a.valid&&(t[e]=a[e],t[e+"UTF8"]=!0)}function Ct(a,e,n){const t=m(a.data),o=U(t,4);Object.assign(a,{vendorVersion:U(t,0),vendorId:U(t,2),strength:o,originalCompressionMethod:n,compressionMethod:R(t,5)}),e.compressionMethod=a.compressionMethod}function bt(a,e){const n=m(a.data);let t=4,o;try{for(;t<a.data.length&&!o;){const s=R(n,t),c=R(n,t+2);s==qe&&(o=a.data.slice(t+4,t+4+c)),t+=4+c}}catch{}try{if(o&&o.length==24){const s=m(o),c=s.getBigUint64(0,!0),r=s.getBigUint64(8,!0),i=s.getBigUint64(16,!0);Object.assign(a,{rawLastModDate:c,rawLastAccessDate:r,rawCreationDate:i});const E=q(c),l=q(r),d=q(i),f={lastModDate:E,lastAccessDate:l,creationDate:d};Object.assign(a,f),Object.assign(e,f)}}catch{}}function Mt(a,e){const n=m(a.data),t=U(n,0),o=[],s=[];(t&1)==1&&(o.push(lt),s.push(ut)),(t&2)==2&&(o.push(Et),s.push(_t)),(t&4)==4&&(o.push(dt),s.push(gt));let c=1;o.forEach((r,i)=>{if(a.data.length>=c+4){const E=_(n,c);e[r]=a[r]=new Date(E*1e3);const l=s[i];a[l]=E}c+=4})}async function xt(a,e,n,t,o){const s=new Uint8Array(4),c=m(s);kt(c,0,e);const r=t+o;return await i(t)||await i(Math.min(r,n));async function i(E){const l=n-E,d=await h(a,l,E);for(let f=d.length-t;f>=0;f--)if(d[f]==s[0]&&d[f+1]==s[1]&&d[f+2]==s[2]&&d[f+3]==s[3])return{offset:l+f,buffer:d.slice(f,f+t).buffer}}}function P(a,e,n){return e[n]===Q?a.options[n]:e[n]}function Ut(a){const e=(a&4294901760)>>16,n=a&65535;try{return new Date(1980+((e&65024)>>9),((e&480)>>5)-1,e&31,(n&63488)>>11,(n&2016)>>5,(n&31)*2,0)}catch{}}function q(a){return new Date(Number(a/BigInt(1e4)-BigInt(116444736e5)))}function U(a,e){return a.getUint8(e)}function R(a,e){return a.getUint16(e,!0)}function _(a,e){return a.getUint32(e,!0)}function Z(a,e){return Number(a.getBigUint64(e,!0))}function kt(a,e,n){a.setUint32(e,n,!0)}function m(a){return new DataView(a.buffer)}const zt=["zip","cbz","ZIP","CBZ"],Ne=["image/jpeg","image/png","image/webp"];async function Bt(a){var c;const e=new Rt(new Uint8Array(await a.arrayBuffer())),t=await new yt(e).getEntries(),o={},s=t.sort((r,i)=>r.filename.localeCompare(i.filename,void 0,{numeric:!0,sensitivity:"base"}));for(const r of s){const i=he(r.filename),E=r.filename.split(".").pop()==="mokuro";if(Ne.includes(i)||E){const l=await((c=r.getData)==null?void 0:c.call(r,new mt(i)));if(l){const d=r.filename.split("/").pop()||r.filename,f=new File([l],d,{type:i});f.webkitRelativePath||Object.defineProperty(f,"webkitRelativePath",{value:r.filename}),o[r.filename]=f}}}return o}function Ae(a){const{webkitRelativePath:e,name:n}=a,t=n.split("."),o=t.pop(),s=t.join(".");let c=s;return e&&(c=e.split(".")[0]),{filename:s,ext:o,path:c}}async function vt(a){try{return new Promise((e,n)=>a.file(t=>{t.webkitRelativePath||Object.defineProperty(t,"webkitRelativePath",{value:a.fullPath.substring(1)}),e(t)},n))}catch(e){console.log(e)}}async function Yt(a,e){if(a.isDirectory){const n=a.createReader();await new Promise(t=>{function o(){n.readEntries(async s=>{if(s.length>0){for(const c of s)c.isFile?e.push(vt(c)):await Yt(c,e);o()}else t()})}o()})}}async function Zt(a){var s;const e={},n=[],t=a.sort((c,r)=>decodeURI(c.name).localeCompare(decodeURI(r.name),void 0,{numeric:!0,sensitivity:"base"}));for(const c of t){const{ext:r,filename:i,path:E}=Ae(c);if(r==="mokuro"){const l=JSON.parse(await c.text());n.includes(l.title_uuid)||n.push(l.title_uuid),e[E]={...e[E],mokuroData:l,volumeName:i};continue}}for(const c of t){const{ext:r,path:i}=Ae(c),{type:E,webkitRelativePath:l}=c,d=E||he(c.name);if(Ne.includes(d)){if(l){const f=l.split("/").at(-1);let A="";Object.keys(e).forEach(p=>{l.startsWith(p)&&(A=p)}),A&&f&&(e[A]={...e[A],files:{...(s=e[A])==null?void 0:s.files,[f]:c}})}continue}if(r&&zt.includes(r)){const f=await Bt(c);if(t.length===1){Zt(Object.values(f));return}e[i]={...e[i],files:f};continue}}const o=Object.values(e);if(o.length>0){if(!o.map(r=>{const{files:i,mokuroData:E,volumeName:l}=r;return!E||!l?(v("Missing .mokuro file"),!1):i?!0:(v("Missing image files"),!1)}).includes(!1)){await Dt();for(const r of n){const i=await W.catalog.get(r),E=o.filter(l=>!(i!=null&&i.manga.some(d=>d.mokuroData.volume_uuid===l.mokuroData.volume_uuid))&&r===l.mokuroData.title_uuid);i?await W.catalog.update(r,{manga:[...i.manga,...E]}):await W.catalog.add({id:r,manga:E})}v("Catalog updated successfully")}}else v("Missing .mokuro file")}export{Ht as f,Zt as p,Yt as s};
